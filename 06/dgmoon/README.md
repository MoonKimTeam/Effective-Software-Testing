# Chapter 06 테스트 더블과 모의 객체

클래스는 다른 클래스에 의존하기도 함 -> 여러 클래스를 함께 실행하여 테스트하는 것이 바람직하기도 함

but 이 장에서는 격리된 방식에 초점 -> 의존성과 함께 수행하는 것은 너무 느리거나 힘듦

다른 테스트에 의존하는 클래스 테스트 시 `테스트 더블`이 도움

테스트 더블 - 가짜 구성요소. 테스트 맥락에 따라 원래 클래스처럼 행동함

이점

- 더 큰 제어권을 가짐 - 객체를 제대로 작동하게 하기 위한 복잡한 설정이 필요 없어짐
- 시뮬레이션은 빠름 - 웹서비스, DB와 통신에 필요한 시간이 없어짐
- 클래스 간의 상호작용 반영 가능

## 더미, 페이크, 스텁, 스파이, 모의 객체

객체 시뮬레이션 방식

- 더미 객체: 테스트 대상 객체에 전달, but 사용되지 않는 객체
- 페이크 객체: 시뮬레이션 대상 클래스 처럼 실제로 동작하는(실제보다 단순하게 동작) 구현체를 가지는 객체 ex) HSQLDB
- 스텁: 호출에 대해 하드코딩된 응답을 제공하는 객체(실제 동작하는 구현체 없음)
    - 종속성 클래스의 반환값 등에 사용
- 모의 객체: 메서드의 응답 설정 가능 -> 스텁과 유사, but <u>모든 상호작용을 저장</u>해서 나중에 단언문에 활용할 수 있음
    - ex) 메서드의 호출 횟수도 단언 가능
    - 메서드 호출, 클래스 상호작용 단언에 사용
- 스파이: 의존성을 감시. 실제 객체를 감싸서 그 행동을 관찰. 원본 객체와의 의존 대상이 어떻게 상호작용하는지 단언
    - 모의 객체보다 구현 쉬움
    - 의존 대상과 어떻게 상호작용하는지 단언
    - 현업에서 잘 사용 X

## 모의 객체 프레임워크

모키토: 스텁, 모의 객체 라이브러리

- mock(<class>): 주어진 클래스로 모의 객체 또는 스텁 생성
- when(<mock>.<method>): 메서드의 동작을 정의하는 연속된 메서드 호출. <value> 반환
- verify(<mock>): 모의 객체와의 상호작용이 예상된 방식대로 일어난다고 단언

### 의존성 스텁화

송장 DB에서 데이터 가져오기 예제

의존하는 객체를 스텁으로 만들면 실제 DB 설정하지 않고 테스트 가능

### 모의 객체와 기댓값

SAP 웹 서비스와 통신하는 클래스를 테스트 - 의존 클래스(InvoiceFilter)를 스텁화

### 인수 포획

ArgumentCaptor 인스턴스를 포획하길 바라는 객체 타입으로 생성하여 인수 포획

### 예외 시뮬레이션

doThrow().when()으로 예외를 시뮬레이션

## 현업

### 모의 객체의 단점

- 모의 객체는 테스트 스위트가 코드가 아니라 모의객체를 테스트 하도록 한다는 주장 있음
- 모의 객체 사용 시 사용하지 않는 테스트보다 코드와 결합하게 됨

### 모의 대상, 비대상

- 모의 해야하는 대상
    - 의존성이 너무 느린 경우
    - 의존성이 외부 인프라와 통신하는 경우
    - 의존성을 시뮬이션 하기 힘든 경우
- 하지 말아야 하는 대상
    - 엔티티
    - 네이티브 라이브러리와 유틸리티 메서드
    - 충분히 단순한 의존성

### 날짜 및 시간 래퍼

- LocalDate 스텁 만들기 -> LocalDate.now() 같은 메서드는 사용 어려움
- 래퍼 클래스로 캡슐화하기

### 소유하지 않은 것을 모의

소유하지 않은 것은 모의하지 말 것.

이유

- 라이브러리에 변경이 발생해도 테스트는 깨지지 않음
- 외부 라이브러리를 모의하는 것은 어려움. ex) hibernate

대신, 라이브러리와의 모든 상호작용을 캡슐화하는 추상화 객체 생성

### 모의에 대한 외부 의견

- 테스트 더블을 사용하려면 시스템이 테스트 가능성을 가지도록 설계해야 함
- 실제 구현에 충실하게 테스트 더블을 구축하는 일은 어렵지만 가능한 그렇게 해야 함
- 고립성보다 현실성이 낫다. 가능하다면 페이크나 스텁, 모의 객체보다 실제 구현을 선택하도록 하기
- 실제 구현을 사용하는 일이 불가능하거나 너무 비용이 많이 든다면 모의 개체보다 페이크 사용
- 모의를 너무 많이 사용하면 위험해질 수 있음
    - 테스가 불분명해지고 덜 효과적
- 모의할 때는 상호작용 테스트보다 상테 테스트가 낫다
- 너무 구체화된 상호작용 테스트 피하고 인수 및 기능 테스트에 초점을 두기
- 좋은 상호작용 테스틀 작성하면서 테스트 대상 시스템을 설계할 때 엄격한 지침 필요